# Flujos Principales - DentiCloud

**User Journeys y Workflows CrÃ­ticos**

---

## Tabla de Contenidos

1. [Flujo 1: Registro de Dentista](#flujo-1-registro-de-dentista)
2. [Flujo 2: ConfiguraciÃ³n de WhatsApp](#flujo-2-configuraciÃ³n-de-whatsapp)
3. [Flujo 3: InvitaciÃ³n de Staff](#flujo-3-invitaciÃ³n-de-staff)
4. [Flujo 4: Staff Multi-Dentista](#flujo-4-staff-multi-dentista)
5. [Flujo 5: Registro de Paciente](#flujo-5-registro-de-paciente)
6. [Flujo 6: Agendar Cita (Dashboard)](#flujo-6-agendar-cita-dashboard)
7. [Flujo 7: Agendar Cita (WhatsApp Bot)](#flujo-7-agendar-cita-whatsapp-bot)
8. [Flujo 8: Paciente con MÃºltiples Dentistas](#flujo-8-paciente-con-mÃºltiples-dentistas)
9. [Flujo 9: AsignaciÃ³n de Consultorios](#flujo-9-asignaciÃ³n-de-consultorios)
10. [Flujo 10: Cambio de Dentista](#flujo-10-cambio-de-dentista)

---

## Flujo 1: Registro de Dentista

**Actor:** Nuevo Dentista
**Objetivo:** Crear cuenta, elegir plan, configurar perfil

### User Journey

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Landing Page â†’ "Comenzar Gratis"                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. SelecciÃ³n de Registro                                        â”‚
â”‚    â€¢ Email/Password                                             â”‚
â”‚    â€¢ Google OAuth                                               â”‚
â”‚    â€¢ Apple OAuth                                                â”‚
â”‚    â€¢ Microsoft OAuth                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Formulario de Registro                                       â”‚
â”‚    â€¢ Nombre completo                                            â”‚
â”‚    â€¢ Email (si no OAuth)                                        â”‚
â”‚    â€¢ Especialidad                                               â”‚
â”‚    â€¢ CÃ©dula profesional                                         â”‚
â”‚    â€¢ TelÃ©fono                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. SelecciÃ³n de Plan                                            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚    â”‚ Starter  â”‚ Professional â”‚  Enterprise  â”‚                  â”‚
â”‚    â”‚ $99/mes  â”‚   $299/mes   â”‚   $599/mes   â”‚                  â”‚
â”‚    â”‚ 50 citas â”‚  200 citas   â”‚ Ilimitado    â”‚                  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Setup Inicial                                                â”‚
â”‚    â€¢ Â¿Tiene consultorio propio? [SÃ­ / No]                      â”‚
â”‚                                                                 â”‚
â”‚    SI: "Agregar direcciÃ³n de consultorio"                      â”‚
â”‚    NO: "RecibirÃ¡ invitaciÃ³n de clÃ­nicas"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Pago (Stripe)                                                â”‚
â”‚    â€¢ Tarjeta de crÃ©dito                                         â”‚
â”‚    â€¢ Billing address                                            â”‚
â”‚    â€¢ Trial: 14 dÃ­as gratis                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Email de ConfirmaciÃ³n                                        â”‚
â”‚    "Bienvenido a DentiCloud!"                                   â”‚
â”‚    â†’ Link para completar perfil                                 â”‚
â”‚    â†’ Link para configurar WhatsApp                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. Dashboard por Primera Vez                                    â”‚
â”‚    âœ… Onboarding wizard                                         â”‚
â”‚    âœ… Tour guiado                                               â”‚
â”‚    âœ… BotÃ³n: "Configurar WhatsApp" (destacado)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### API Calls

```typescript
// 1. Registro
POST /api/auth/register
{
  "email": "dr.juan@example.com",
  "password": "...",
  "firstName": "Juan",
  "lastName": "PÃ©rez",
  "specialty": "Ortodoncia",
  "license": "1234567",
  "phone": "+52-xxx-xxx-xxxx"
}

// Response
{
  "user": { "id": "...", "email": "..." },
  "tenant": { "id": "tenant-123", "type": "dentist" },
  "accessToken": "...",
  "refreshToken": "..."
}

// 2. Seleccionar Plan
POST /api/subscriptions
{
  "tenantId": "tenant-123",
  "planId": "plan-professional",
  "paymentMethodId": "pm_..."
}

// 3. Setup Inicial
PATCH /api/tenants/tenant-123/setup
{
  "hasOwnOffice": false,
  "officeAddress": null
}
```

---

## Flujo 2: ConfiguraciÃ³n de WhatsApp

**Actor:** Dentista
**Objetivo:** Conectar nÃºmero de WhatsApp para chatbot

### User Journey

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Dashboard â†’ ConfiguraciÃ³n â†’ WhatsApp                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Pantalla de ConexiÃ³n                                         â”‚
â”‚                                                                 â”‚
â”‚    "Conecta tu WhatsApp Business para recibir mensajes          â”‚
â”‚     de tus pacientes y automatizar citas"                       â”‚
â”‚                                                                 â”‚
â”‚    â€¢ NÃºmero de WhatsApp: +52-xxx-xxx-xxxx                      â”‚
â”‚    â€¢ BotÃ³n: "Generar CÃ³digo QR"                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Generar QR (Baileys)                                         â”‚
â”‚                                                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚    â”‚   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ  â”‚   "Escanea este cÃ³digo con              â”‚
â”‚    â”‚   â–ˆ  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â–ˆ   â”‚    WhatsApp en tu telÃ©fono"             â”‚
â”‚    â”‚   â–ˆâ–ˆâ–ˆ  â–ˆâ–ˆ  â–ˆâ–ˆâ–ˆ  â”‚                                          â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                                 â”‚
â”‚    Estado: â³ Esperando conexiÃ³n...                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Usuario Escanea QR                                           â”‚
â”‚    â€¢ Abre WhatsApp en mÃ³vil                                     â”‚
â”‚    â€¢ MenÃº â†’ Dispositivos vinculados                             â”‚
â”‚    â€¢ Vincular un dispositivo                                    â”‚
â”‚    â€¢ Escanea QR de la pantalla                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ConexiÃ³n Exitosa                                             â”‚
â”‚                                                                 â”‚
â”‚    âœ… WhatsApp conectado correctamente                          â”‚
â”‚                                                                 â”‚
â”‚    Estado: ğŸŸ¢ Conectado                                         â”‚
â”‚    NÃºmero: +52-xxx-xxx-xxxx                                    â”‚
â”‚                                                                 â”‚
â”‚    BotÃ³n: "Probar Bot"                                          â”‚
â”‚    BotÃ³n: "Desconectar"                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ConfiguraciÃ³n del Bot                                        â”‚
â”‚    â€¢ Mensaje de bienvenida (customizable)                       â”‚
â”‚    â€¢ Horarios de atenciÃ³n                                       â”‚
â”‚    â€¢ Mensajes fuera de horario                                  â”‚
â”‚    â€¢ Auto-respuestas rÃ¡pidas                                    â”‚
â”‚    â€¢ PersonalizaciÃ³n con IA:                                    â”‚
â”‚      - Tono (formal/informal)                                   â”‚
â”‚      - Info de servicios                                        â”‚
â”‚      - Precios                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### WebSocket Flow

```typescript
// Frontend conecta WebSocket
const socket = io('wss://api.denticloud.com');

socket.emit('start-whatsapp-connection', {
  dentistId: 'tenant-123'
});

// Backend genera QR con Baileys y envÃ­a
socket.on('qr-code-generated', (data) => {
  // Mostrar QR en pantalla
  setQRCode(data.qr);
});

// ConexiÃ³n exitosa
socket.on('whatsapp-connected', (data) => {
  setConnectionStatus('connected');
  showSuccessMessage('WhatsApp conectado!');
});

// DesconexiÃ³n
socket.on('whatsapp-disconnected', () => {
  setConnectionStatus('disconnected');
  showWarningMessage('WhatsApp desconectado. Reconectar?');
});
```

### API Calls

```typescript
// 1. Iniciar conexiÃ³n
POST /api/whatsapp/connect
{
  "dentistId": "tenant-123",
  "phoneNumber": "+52-xxx-xxx-xxxx"
}

// Response
{
  "connectionId": "conn-456",
  "status": "connecting",
  "qrCode": "data:image/png;base64,..."
}

// 2. Actualizar configuraciÃ³n del bot
PATCH /api/whatsapp/tenant-123/config
{
  "welcomeMessage": "Hola! Soy el asistente del Dr. PÃ©rez...",
  "businessHours": {
    "monday": { "start": "09:00", "end": "18:00" },
    // ...
  },
  "tone": "formal",
  "aiPrompt": "Eres un asistente dental profesional..."
}
```

---

## Flujo 3: InvitaciÃ³n de Staff

**Actor:** Dentista
**Objetivo:** Invitar staff (secretaria, asistente) a trabajar en su cuenta

### User Journey

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Dashboard â†’ Equipo â†’ "Invitar Staff"                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Formulario de InvitaciÃ³n                                     â”‚
â”‚    â€¢ Email: ana@example.com                                     â”‚
â”‚    â€¢ Nombre: Ana LÃ³pez                                          â”‚
â”‚    â€¢ Rol: [Receptionist / Billing / Assistant]                 â”‚
â”‚    â€¢ Permisos:                                                  â”‚
â”‚      â˜‘ Ver pacientes                                            â”‚
â”‚      â˜‘ Agendar citas                                            â”‚
â”‚      â˜‘ Ver historial clÃ­nico                                    â”‚
â”‚      â˜ Editar tratamientos                                      â”‚
â”‚      â˜‘ Gestionar pagos                                          â”‚
â”‚    â€¢ Consultorios asignados:                                    â”‚
â”‚      â˜‘ Consultorio 1 - ClÃ­nica ABC                             â”‚
â”‚      â˜ Consultorio 2 - ClÃ­nica XYZ                             â”‚
â”‚                                                                 â”‚
â”‚    BotÃ³n: "Enviar InvitaciÃ³n"                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Email a Staff                                                â”‚
â”‚    Subject: "Dr. Juan PÃ©rez te invitÃ³ a DentiCloud"            â”‚
â”‚                                                                 â”‚
â”‚    "Hola Ana,                                                   â”‚
â”‚     El Dr. Juan PÃ©rez te ha invitado a unirte a su equipo      â”‚
â”‚     en DentiCloud como Receptionist.                            â”‚
â”‚                                                                 â”‚
â”‚     [Aceptar InvitaciÃ³n]"                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Staff Acepta InvitaciÃ³n                                      â”‚
â”‚                                                                 â”‚
â”‚    Â¿Ya tienes cuenta en DentiCloud?                             â”‚
â”‚    â€¢ [SÃ­, iniciar sesiÃ³n]                                       â”‚
â”‚    â€¢ [No, crear cuenta]                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5a. SI tiene cuenta â†’ Login                                     â”‚
â”‚     â€¢ Email + Password                                          â”‚
â”‚     â€¢ Acepta invitaciÃ³n                                         â”‚
â”‚     â€¢ Se agrega membership                                      â”‚
â”‚                                                                 â”‚
â”‚ 5b. NO tiene cuenta â†’ Registro                                  â”‚
â”‚     â€¢ Crear cuenta de staff                                     â”‚
â”‚     â€¢ Acepta invitaciÃ³n                                         â”‚
â”‚     â€¢ Se crea user + membership                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Staff Dashboard                                              â”‚
â”‚                                                                 â”‚
â”‚    "Trabajando para:"                                           â”‚
â”‚    â€¢ Dr. Juan PÃ©rez (ClÃ­nica ABC) [Activo]                     â”‚
â”‚                                                                 â”‚
â”‚    Selector de dentista: [Dr. Juan PÃ©rez â–¼]                    â”‚
â”‚                                                                 â”‚
â”‚    â†’ Acceso a citas, pacientes, agenda                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### API Calls

```typescript
// 1. Dentista envÃ­a invitaciÃ³n
POST /api/staff/invitations
{
  "tenantId": "tenant-123", // Dr. PÃ©rez
  "email": "ana@example.com",
  "role": "staff_receptionist",
  "permissions": ["view_patients", "manage_appointments", "view_billing"],
  "operatoryIds": ["operatory-1"]
}

// Response
{
  "invitationId": "inv-789",
  "status": "pending",
  "expiresAt": "2025-01-15T00:00:00Z"
}

// 2. Staff acepta invitaciÃ³n
POST /api/staff/invitations/inv-789/accept
{
  "userId": "user-staff-456" // Si ya tiene cuenta
}

// Response - Crea TenantMembership
{
  "membership": {
    "id": "mem-999",
    "userId": "user-staff-456",
    "tenantId": "tenant-123",
    "role": "staff_receptionist",
    "isActive": true
  }
}
```

---

## Flujo 4: Staff Multi-Dentista

**Actor:** Staff (Ana)
**Objetivo:** Trabajar para mÃºltiples dentistas desde una sola cuenta

### User Journey

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Contexto: Ana trabaja para Dr. PÃ©rez y Dr. LÃ³pez               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Ana Inicia SesiÃ³n                                            â”‚
â”‚    â€¢ Email: ana@example.com                                     â”‚
â”‚    â€¢ Password: ***                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Dashboard - Selector de Dentista                             â”‚
â”‚                                                                 â”‚
â”‚    "Trabajando para:"                                           â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚    â”‚ Dr. Juan PÃ©rez (ClÃ­nica ABC)    âœ“   â”‚                    â”‚
â”‚    â”‚ Dr. Carlos LÃ³pez (ClÃ­nica ABC)      â”‚                    â”‚
â”‚    â”‚ Dra. GÃ³mez (ClÃ­nica XYZ)            â”‚                    â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                 â”‚
â”‚    â†’ Selecciona "Dr. Juan PÃ©rez"                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Vista de Agenda (Filtrada por Dr. PÃ©rez)                    â”‚
â”‚                                                                 â”‚
â”‚    ğŸ“… Martes, 15 Enero 2025                                     â”‚
â”‚                                                                 â”‚
â”‚    09:00 - Juan RodrÃ­guez (Limpieza)                           â”‚
â”‚    10:00 - MarÃ­a GarcÃ­a (Ortodoncia)                           â”‚
â”‚    11:30 - LIBRE                                                â”‚
â”‚    14:00 - Pedro LÃ³pez (RevisiÃ³n)                              â”‚
â”‚                                                                 â”‚
â”‚    BotÃ³n: "Nueva Cita"                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Ana Cambia a Otro Dentista                                   â”‚
â”‚                                                                 â”‚
â”‚    Selector: [Dr. Carlos LÃ³pez â–¼]                               â”‚
â”‚                                                                 â”‚
â”‚    â†’ Ahora ve agenda de Dr. LÃ³pez                               â”‚
â”‚    â†’ Ahora ve pacientes de Dr. LÃ³pez                            â”‚
â”‚    â†’ Permisos segÃºn membership con Dr. LÃ³pez                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Vista Combinada (Opcional)                                   â”‚
â”‚                                                                 â”‚
â”‚    "Ver agenda de todos los dentistas"                          â”‚
â”‚                                                                 â”‚
â”‚    ğŸ“… Martes, 15 Enero 2025                                     â”‚
â”‚                                                                 â”‚
â”‚    ğŸŸ¦ Dr. PÃ©rez                                                 â”‚
â”‚    09:00 - Juan RodrÃ­guez                                       â”‚
â”‚                                                                 â”‚
â”‚    ğŸŸ© Dr. LÃ³pez                                                 â”‚
â”‚    10:00 - Ana MartÃ­nez                                         â”‚
â”‚                                                                 â”‚
â”‚    ğŸŸ¦ Dr. PÃ©rez                                                 â”‚
â”‚    11:00 - Carlos DÃ­az                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Frontend Context Management

```typescript
// Zustand store
interface TenantContextStore {
  userId: string;
  activeTenantId: string | null;
  memberships: TenantMembership[];

  setActiveTenant: (tenantId: string) => void;
  getActiveMembership: () => TenantMembership | null;
}

// Component
function DentistSelector() {
  const { memberships, activeTenantId, setActiveTenant } = useTenantContext();

  return (
    <Select value={activeTenantId} onValueChange={setActiveTenant}>
      {memberships.map(m => (
        <SelectItem key={m.tenantId} value={m.tenantId}>
          {m.dentist.name} ({m.clinic?.name})
        </SelectItem>
      ))}
    </Select>
  );
}

// API calls automÃ¡ticamente usan activeTenantId
async function getAppointments() {
  const { activeTenantId } = useTenantContext();

  const response = await fetch('/api/appointments', {
    headers: {
      'X-Tenant-ID': activeTenantId
    }
  });

  return response.json();
}
```

---

## Flujo 5: Registro de Paciente

**Actor:** Staff o Dentista
**Objetivo:** Registrar nuevo paciente en el sistema

### User Journey

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Dashboard â†’ Pacientes â†’ "Nuevo Paciente"                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. BÃºsqueda de Paciente Existente                               â”‚
â”‚                                                                 â”‚
â”‚    "Â¿El paciente ya existe en el sistema?"                      â”‚
â”‚                                                                 â”‚
â”‚    ğŸ” Buscar por: Email o TelÃ©fono                              â”‚
â”‚    Email: luis@example.com                                      â”‚
â”‚                                                                 â”‚
â”‚    [Buscar]                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3a. SI existe â†’ Agregar relaciÃ³n                                â”‚
â”‚                                                                 â”‚
â”‚    âœ“ Paciente encontrado:                                       â”‚
â”‚    Luis RodrÃ­guez - luis@example.com                            â”‚
â”‚                                                                 â”‚
â”‚    Historial previo:                                            â”‚
â”‚    â€¢ Dr. Alberto GÃ³mez (2023-2024)                             â”‚
â”‚                                                                 â”‚
â”‚    Â¿Agregar a tu lista de pacientes?                            â”‚
â”‚    [SÃ­, agregar]  [No, crear nuevo]                            â”‚
â”‚                                                                 â”‚
â”‚ 3b. NO existe â†’ Crear nuevo paciente                            â”‚
â”‚                                                                 â”‚
â”‚    "Nuevo Paciente"                                             â”‚
â”‚    [Continuar al formulario]                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Formulario de Paciente                                       â”‚
â”‚                                                                 â”‚
â”‚    ** InformaciÃ³n Personal **                                   â”‚
â”‚    â€¢ Nombre: Luis                                               â”‚
â”‚    â€¢ Apellidos: RodrÃ­guez GarcÃ­a                                â”‚
â”‚    â€¢ Fecha de nacimiento: 15/03/1985                            â”‚
â”‚    â€¢ GÃ©nero: [Masculino â–¼]                                      â”‚
â”‚    â€¢ Email: luis@example.com                                    â”‚
â”‚    â€¢ TelÃ©fono: +52-xxx-xxx-xxxx                                â”‚
â”‚    â€¢ DirecciÃ³n: Calle 123...                                    â”‚
â”‚                                                                 â”‚
â”‚    ** InformaciÃ³n MÃ©dica **                                     â”‚
â”‚    â€¢ Alergias: Penicilina                                       â”‚
â”‚    â€¢ Condiciones mÃ©dicas: Diabetes tipo 2                       â”‚
â”‚    â€¢ Medicamentos actuales: Metformina                          â”‚
â”‚    â€¢ Contacto de emergencia: MarÃ­a RodrÃ­guez (+52...)          â”‚
â”‚                                                                 â”‚
â”‚    ** InformaciÃ³n del Seguro **                                 â”‚
â”‚    â€¢ Aseguradora: Seguros ABC                                   â”‚
â”‚    â€¢ NÃºmero de pÃ³liza: 123456                                   â”‚
â”‚                                                                 â”‚
â”‚    [Guardar]                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Paciente Creado                                              â”‚
â”‚                                                                 â”‚
â”‚    âœ… Paciente creado exitosamente                              â”‚
â”‚                                                                 â”‚
â”‚    Luis RodrÃ­guez                                               â”‚
â”‚    â€¢ ID: PAT-12345                                              â”‚
â”‚    â€¢ Estado: Activo                                             â”‚
â”‚                                                                 â”‚
â”‚    Acciones:                                                    â”‚
â”‚    [Agendar Primera Cita]                                       â”‚
â”‚    [Crear Odontograma]                                          â”‚
â”‚    [Enviar Acceso al Portal]                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Email al Paciente                                            â”‚
â”‚                                                                 â”‚
â”‚    Subject: "Bienvenido a DentiCloud"                           â”‚
â”‚                                                                 â”‚
â”‚    "Hola Luis,                                                  â”‚
â”‚     Te has registrado en el sistema del Dr. PÃ©rez.             â”‚
â”‚                                                                 â”‚
â”‚     Accede a tu portal de paciente:                             â”‚
â”‚     [Crear ContraseÃ±a]                                          â”‚
â”‚                                                                 â”‚
â”‚     Desde el portal podrÃ¡s:                                     â”‚
â”‚     â€¢ Ver tu historial                                          â”‚
â”‚     â€¢ Agendar citas                                             â”‚
â”‚     â€¢ Ver facturas                                              â”‚
â”‚     â€¢ Descargar documentos"                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### API Calls

```typescript
// 1. Buscar paciente existente
GET /api/patients/search?email=luis@example.com

// Response
{
  "found": true,
  "patient": {
    "id": "patient-123",
    "name": "Luis RodrÃ­guez",
    "email": "luis@example.com",
    "previousDentists": [
      { "id": "dentist-456", "name": "Dr. Alberto GÃ³mez" }
    ]
  }
}

// 2a. Si existe: Agregar relaciÃ³n
POST /api/patient-dentist-relations
{
  "patientId": "patient-123",
  "dentistId": "tenant-current", // Dentista actual
  "isActive": true,
  "startedAt": "2025-01-15T00:00:00Z"
}

// 2b. Si NO existe: Crear paciente
POST /api/patients
{
  "firstName": "Luis",
  "lastName": "RodrÃ­guez GarcÃ­a",
  "email": "luis@example.com",
  "phone": "+52-xxx-xxx-xxxx",
  "dateOfBirth": "1985-03-15",
  "gender": "male",
  "medicalHistory": {
    "allergies": ["Penicilina"],
    "conditions": ["Diabetes tipo 2"],
    "medications": ["Metformina"]
  }
}

// Response - AutomÃ¡ticamente crea relaciÃ³n con dentista actual
{
  "patient": { "id": "patient-789", ... },
  "relation": { "id": "rel-999", "dentistId": "tenant-current" }
}

// 3. Enviar invitaciÃ³n al portal
POST /api/patients/patient-789/send-portal-invite
```

---

## Flujo 6: Agendar Cita (Dashboard)

**Actor:** Staff o Dentista
**Objetivo:** Agendar cita para paciente

### User Journey

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Dashboard â†’ Agenda â†’ "Nueva Cita"                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Formulario de Cita                                           â”‚
â”‚                                                                 â”‚
â”‚    ** Paciente **                                               â”‚
â”‚    ğŸ” Buscar paciente: [Luis RodrÃ­guez___]                      â”‚
â”‚                                                                 â”‚
â”‚    Resultados:                                                  â”‚
â”‚    â€¢ Luis RodrÃ­guez GarcÃ­a - luis@example.com                   â”‚
â”‚      Ãšltima cita: 10 Dic 2024                                   â”‚
â”‚    [Seleccionar]                                                â”‚
â”‚                                                                 â”‚
â”‚    ** Fecha y Hora **                                           â”‚
â”‚    Fecha: [15 Enero 2025 ğŸ“…]                                    â”‚
â”‚    Hora: [10:00 ğŸ•]                                             â”‚
â”‚    DuraciÃ³n: [60 minutos â–¼]                                     â”‚
â”‚                                                                 â”‚
â”‚    ** Consultorio **                                            â”‚
â”‚    Consultorio: [Consultorio 1 - ClÃ­nica ABC â–¼]                â”‚
â”‚    Estado: âœ… Disponible                                        â”‚
â”‚                                                                 â”‚
â”‚    ** Procedimiento **                                          â”‚
â”‚    Tipo: [Limpieza â–¼]                                           â”‚
â”‚    Notas: RevisiÃ³n de rutina                                    â”‚
â”‚                                                                 â”‚
â”‚    ** Recordatorios **                                          â”‚
â”‚    â˜‘ Email (24h antes)                                          â”‚
â”‚    â˜‘ WhatsApp (2h antes)                                        â”‚
â”‚    â˜ SMS (1h antes)                                             â”‚
â”‚                                                                 â”‚
â”‚    [Guardar Cita]                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Validaciones                                                 â”‚
â”‚                                                                 â”‚
â”‚    Backend valida:                                              â”‚
â”‚    âœ“ Consultorio disponible en ese horario                      â”‚
â”‚    âœ“ Dentista no tiene otra cita                                â”‚
â”‚    âœ“ Paciente no tiene conflictos                               â”‚
â”‚    âœ“ Horario dentro de business hours                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Cita Creada                                                  â”‚
â”‚                                                                 â”‚
â”‚    âœ… Cita agendada exitosamente                                â”‚
â”‚                                                                 â”‚
â”‚    ğŸ“… 15 Enero 2025 - 10:00 AM                                  â”‚
â”‚    ğŸ‘¤ Luis RodrÃ­guez                                            â”‚
â”‚    ğŸ¥ Consultorio 1 - ClÃ­nica ABC                               â”‚
â”‚    ğŸ¦· Limpieza dental                                           â”‚
â”‚                                                                 â”‚
â”‚    [Ver en Calendario]  [Enviar ConfirmaciÃ³n]                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Notificaciones AutomÃ¡ticas                                   â”‚
â”‚                                                                 â”‚
â”‚    ğŸ“§ Email al paciente:                                        â”‚
â”‚    "Cita confirmada para el 15 Enero a las 10:00"              â”‚
â”‚                                                                 â”‚
â”‚    ğŸ’¬ WhatsApp al paciente:                                     â”‚
â”‚    "Hola Luis, tu cita con el Dr. PÃ©rez estÃ¡ confirmada..."    â”‚
â”‚                                                                 â”‚
â”‚    ğŸ“… Sync a Google Calendar (si configurado):                  â”‚
â”‚    Evento creado en calendario del dentista                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Job Queue - Recordatorios                                    â”‚
â”‚                                                                 â”‚
â”‚    BullMQ job creado:                                           â”‚
â”‚    â€¢ Email reminder: 14 Enero 10:00 (24h antes)                â”‚
â”‚    â€¢ WhatsApp reminder: 15 Enero 08:00 (2h antes)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### API Calls

```typescript
// 1. Verificar disponibilidad
GET /api/appointments/availability?date=2025-01-15&time=10:00&operatoryId=op-1&duration=60

// Response
{
  "available": true,
  "conflicts": []
}

// 2. Crear cita
POST /api/appointments
{
  "tenantId": "tenant-123", // Dr. PÃ©rez
  "patientId": "patient-789",
  "operatoryId": "operatory-1",
  "appointmentDate": "2025-01-15T10:00:00Z",
  "duration": 60,
  "procedureType": "cleaning",
  "notes": "RevisiÃ³n de rutina",
  "reminders": {
    "email": { "enabled": true, "hoursBefore": 24 },
    "whatsapp": { "enabled": true, "hoursBefore": 2 }
  }
}

// Response
{
  "appointment": {
    "id": "appt-555",
    "status": "scheduled",
    "confirmationCode": "DENT-555"
  }
}

// 3. Backend crea jobs en BullMQ
await emailQueue.add('appointment-reminder', {
  appointmentId: 'appt-555',
  type: 'email',
  sendAt: '2025-01-14T10:00:00Z'
}, {
  delay: calculateDelay('2025-01-14T10:00:00Z')
});

await whatsappQueue.add('appointment-reminder', {
  appointmentId: 'appt-555',
  type: 'whatsapp',
  sendAt: '2025-01-15T08:00:00Z'
}, {
  delay: calculateDelay('2025-01-15T08:00:00Z')
});
```

---

## Flujo 7: Agendar Cita (WhatsApp Bot)

**Actor:** Paciente (vÃ­a WhatsApp)
**Objetivo:** Agendar cita conversando con chatbot

### User Journey

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WhatsApp Chat con Dr. PÃ©rez                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ“± Paciente: "Hola"

ğŸ¤– Bot: "Â¡Hola! Soy el asistente del Dr. Juan PÃ©rez.
        Â¿En quÃ© puedo ayudarte hoy?

        1ï¸âƒ£ Agendar una cita
        2ï¸âƒ£ Consultar mi prÃ³xima cita
        3ï¸âƒ£ Ver facturas pendientes
        4ï¸âƒ£ Hablar con un humano"

ğŸ“± Paciente: "1"

ğŸ¤– Bot: "Perfecto! Para agendar tu cita necesito algunos datos.

        Â¿CuÃ¡l es tu nombre completo?"

ğŸ“± Paciente: "Luis RodrÃ­guez"

ğŸ¤– Bot: [Busca en BD por nombre]

        "Hola Luis! Veo que ya eres paciente del Dr. PÃ©rez.
        Tu Ãºltima cita fue el 10 de Diciembre.

        Â¿Para quÃ© tipo de procedimiento necesitas la cita?

        1ï¸âƒ£ Limpieza dental
        2ï¸âƒ£ RevisiÃ³n general
        3ï¸âƒ£ Dolor/Urgencia
        4ï¸âƒ£ Ortodoncia
        5ï¸âƒ£ Otro"

ğŸ“± Paciente: "1"

ğŸ¤– Bot: [Consulta disponibilidad con GPT-4 function calling]

        "Entendido, limpieza dental.

        Tengo las siguientes fechas disponibles:

        â€¢ MaÃ±ana (15 Ene) - 10:00 AM
        â€¢ MaÃ±ana (15 Ene) - 2:00 PM
        â€¢ Jueves (16 Ene) - 11:00 AM
        â€¢ Viernes (17 Ene) - 9:00 AM

        Â¿CuÃ¡l prefieres?"

ğŸ“± Paciente: "MaÃ±ana a las 10"

ğŸ¤– Bot: [Llama function agendar_cita()]

        "âœ… Â¡Listo! Tu cita estÃ¡ confirmada:

        ğŸ“… 15 de Enero, 2025
        ğŸ• 10:00 AM
        ğŸ¥ Consultorio 1 - ClÃ­nica ABC
        ğŸ¦· Limpieza dental
        ğŸ‘¨â€âš•ï¸ Dr. Juan PÃ©rez

        Te enviarÃ© recordatorios por WhatsApp.

        CÃ³digo de confirmaciÃ³n: DENT-555"

ğŸ“± Paciente: "Gracias"

ğŸ¤– Bot: "Â¡De nada! Nos vemos maÃ±ana a las 10:00 AM.

        Si necesitas cancelar o reprogramar, escrÃ­beme."
```

### Backend - GPT-4 Function Calling

```typescript
// WhatsApp message handler
async handleIncomingMessage(dentistId: string, message: WAMessage) {
  const patientPhone = message.key.remoteJid;
  const messageText = message.message?.conversation || '';

  // Obtener historial de conversaciÃ³n
  const chatHistory = await this.getChatHistory(dentistId, patientPhone);

  // Llamar GPT-4 con function calling
  const completion = await this.openai.chat.completions.create({
    model: 'gpt-4',
    messages: [
      {
        role: 'system',
        content: `Eres el asistente virtual del Dr. ${dentist.name}.
                  Tu trabajo es ayudar a los pacientes a agendar citas,
                  consultar informaciÃ³n y responder preguntas.
                  SÃ© amable, profesional y conciso.`
      },
      ...chatHistory,
      {
        role: 'user',
        content: messageText
      }
    ],
    functions: [
      {
        name: 'buscar_paciente',
        description: 'Busca un paciente por nombre o telÃ©fono',
        parameters: {
          type: 'object',
          properties: {
            name: { type: 'string' },
            phone: { type: 'string' }
          }
        }
      },
      {
        name: 'consultar_disponibilidad',
        description: 'Consulta fechas disponibles para citas',
        parameters: {
          type: 'object',
          properties: {
            procedureType: { type: 'string', enum: ['cleaning', 'checkup', 'emergency'] },
            preferredDates: { type: 'array', items: { type: 'string' } }
          }
        }
      },
      {
        name: 'agendar_cita',
        description: 'Agenda una cita para el paciente',
        parameters: {
          type: 'object',
          properties: {
            patientId: { type: 'string' },
            date: { type: 'string', format: 'date-time' },
            procedureType: { type: 'string' },
            notes: { type: 'string' }
          },
          required: ['patientId', 'date', 'procedureType']
        }
      },
      {
        name: 'consultar_proxima_cita',
        description: 'Consulta la prÃ³xima cita del paciente',
        parameters: {
          type: 'object',
          properties: {
            patientId: { type: 'string' }
          }
        }
      }
    ],
    function_call: 'auto'
  });

  const response = completion.choices[0];

  // Si GPT-4 quiere llamar una funciÃ³n
  if (response.finish_reason === 'function_call') {
    const functionName = response.message.function_call.name;
    const functionArgs = JSON.parse(response.message.function_call.arguments);

    // Ejecutar funciÃ³n
    let functionResult;
    switch (functionName) {
      case 'buscar_paciente':
        functionResult = await this.searchPatient(functionArgs);
        break;
      case 'consultar_disponibilidad':
        functionResult = await this.getAvailability(dentistId, functionArgs);
        break;
      case 'agendar_cita':
        functionResult = await this.createAppointment(dentistId, functionArgs);
        break;
      case 'consultar_proxima_cita':
        functionResult = await this.getNextAppointment(functionArgs.patientId);
        break;
    }

    // Volver a llamar GPT-4 con resultado de funciÃ³n
    const finalResponse = await this.openai.chat.completions.create({
      model: 'gpt-4',
      messages: [
        ...chatHistory,
        response.message,
        {
          role: 'function',
          name: functionName,
          content: JSON.stringify(functionResult)
        }
      ]
    });

    // Enviar respuesta al paciente
    await this.sendWhatsAppMessage(dentistId, patientPhone, finalResponse.choices[0].message.content);
  } else {
    // Respuesta directa sin funciÃ³n
    await this.sendWhatsAppMessage(dentistId, patientPhone, response.message.content);
  }

  // Guardar en chat history
  await this.saveChatMessage(dentistId, patientPhone, messageText, response.message.content);
}

// Function implementation
async getAvailability(dentistId: string, params: any) {
  const operatories = await prisma.operatoryAssignment.findMany({
    where: { dentist_id: dentistId, is_active: true }
  });

  const availableSlots = [];

  for (const op of operatories) {
    const slots = await this.findAvailableSlots(op.operatory_id, params.procedureType);
    availableSlots.push(...slots);
  }

  return {
    availableSlots: availableSlots.slice(0, 5), // Top 5
    procedureType: params.procedureType
  };
}

async createAppointment(dentistId: string, params: any) {
  const appointment = await prisma.appointment.create({
    data: {
      tenant_id: dentistId,
      patient_id: params.patientId,
      appointment_date: params.date,
      procedure_type: params.procedureType,
      notes: params.notes,
      status: 'scheduled',
      created_via: 'whatsapp'
    }
  });

  // Crear recordatorios
  await this.scheduleReminders(appointment.id);

  return {
    success: true,
    appointmentId: appointment.id,
    confirmationCode: appointment.confirmation_code
  };
}
```

---

## Flujo 8: Paciente con MÃºltiples Dentistas

**Actor:** Paciente
**Objetivo:** Ver historial completo con todos los dentistas

### User Journey

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Contexto: Luis vio al Dr. GÃ³mez (2023) y ahora al Dr. PÃ©rez    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Luis Accede al Portal de Pacientes                           â”‚
â”‚    â€¢ URL: https://patient.denticloud.com                        â”‚
â”‚    â€¢ Login: luis@example.com                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Dashboard del Paciente                                       â”‚
â”‚                                                                 â”‚
â”‚    "Mis Dentistas"                                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚ ğŸ¦· Dr. Juan PÃ©rez                     â”‚                   â”‚
â”‚    â”‚    ClÃ­nica ABC                        â”‚                   â”‚
â”‚    â”‚    Estado: Activo                     â”‚                   â”‚
â”‚    â”‚    Ãšltima cita: 10 Dic 2024          â”‚                   â”‚
â”‚    â”‚    [Ver Historial]                    â”‚                   â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚    â”‚ ğŸ¦· Dr. Alberto GÃ³mez                  â”‚                   â”‚
â”‚    â”‚    ClÃ­nica XYZ                        â”‚                   â”‚
â”‚    â”‚    Estado: Inactivo (desde Jul 2024)  â”‚                   â”‚
â”‚    â”‚    Ãšltima cita: 15 Jun 2024          â”‚                   â”‚
â”‚    â”‚    [Ver Historial]                    â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Luis Selecciona "Dr. Juan PÃ©rez"                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Historial con Dr. PÃ©rez                                      â”‚
â”‚                                                                 â”‚
â”‚    ğŸ‘¨â€âš•ï¸ Dr. Juan PÃ©rez - ClÃ­nica ABC                            â”‚
â”‚    ğŸ“… Paciente desde: 1 Agosto 2024                             â”‚
â”‚                                                                 â”‚
â”‚    ** PrÃ³ximas Citas **                                         â”‚
â”‚    â€¢ 15 Enero 2025 - 10:00 AM - Limpieza                       â”‚
â”‚      [Cancelar] [Reprogramar]                                   â”‚
â”‚                                                                 â”‚
â”‚    ** Historial de Citas **                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚    â”‚ ğŸ“… 10 Dic 2024 - Limpieza           â”‚                     â”‚
â”‚    â”‚    Notas: Todo en orden             â”‚                     â”‚
â”‚    â”‚    [Ver Detalles]                   â”‚                     â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
â”‚    â”‚ ğŸ“… 5 Oct 2024 - RevisiÃ³n            â”‚                     â”‚
â”‚    â”‚    Tratamiento: Filling molar 36    â”‚                     â”‚
â”‚    â”‚    [Ver Detalles]                   â”‚                     â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
â”‚    â”‚ ğŸ“… 1 Ago 2024 - Primera consulta    â”‚                     â”‚
â”‚    â”‚    [Ver Detalles]                   â”‚                     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                 â”‚
â”‚    ** Odontograma **                                            â”‚
â”‚    [Ver Odontograma Completo]                                   â”‚
â”‚                                                                 â”‚
â”‚    ** Facturas **                                               â”‚
â”‚    â€¢ Pendiente: $1,500 MXN                                      â”‚
â”‚    â€¢ Pagado: $3,000 MXN                                         â”‚
â”‚    [Ver Facturas]                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Luis Cambia a "Dr. Alberto GÃ³mez"                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Historial con Dr. GÃ³mez                                      â”‚
â”‚                                                                 â”‚
â”‚    ğŸ‘¨â€âš•ï¸ Dr. Alberto GÃ³mez - ClÃ­nica XYZ                         â”‚
â”‚    ğŸ“… Paciente: Ene 2023 - Jul 2024 (Inactivo)                  â”‚
â”‚                                                                 â”‚
â”‚    ** Historial de Citas **                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚    â”‚ ğŸ“… 15 Jun 2024 - Limpieza           â”‚                     â”‚
â”‚    â”‚    [Ver Detalles]                   â”‚                     â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
â”‚    â”‚ ğŸ“… 10 Mar 2024 - Ortodoncia         â”‚                     â”‚
â”‚    â”‚    Ajuste de brackets               â”‚                     â”‚
â”‚    â”‚    [Ver Detalles]                   â”‚                     â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
â”‚    â”‚ ğŸ“… 5 Ene 2023 - Primera consulta    â”‚                     â”‚
â”‚    â”‚    [Ver Detalles]                   â”‚                     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                 â”‚
â”‚    ** Odontograma **                                            â”‚
â”‚    [Ver Odontograma de ese perÃ­odo]                             â”‚
â”‚                                                                 â”‚
â”‚    â„¹ï¸ Esta relaciÃ³n estÃ¡ inactiva. Si deseas reactivarla,      â”‚
â”‚       contacta al Dr. GÃ³mez.                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### API Calls

```typescript
// 1. Patient login
POST /api/auth/patient/login
{
  "email": "luis@example.com",
  "password": "***"
}

// Response
{
  "user": { "id": "patient-789", "role": "patient" },
  "accessToken": "...",
  "dentists": [
    {
      "dentistId": "tenant-123",
      "dentistName": "Dr. Juan PÃ©rez",
      "clinicName": "ClÃ­nica ABC",
      "isActive": true,
      "relationId": "rel-999"
    },
    {
      "dentistId": "tenant-456",
      "dentistName": "Dr. Alberto GÃ³mez",
      "clinicName": "ClÃ­nica XYZ",
      "isActive": false,
      "relationId": "rel-888"
    }
  ]
}

// 2. Get history with specific dentist
GET /api/patients/patient-789/dentists/tenant-123/history

// Response
{
  "dentist": { "id": "tenant-123", "name": "Dr. Juan PÃ©rez" },
  "relationStartDate": "2024-08-01",
  "isActive": true,
  "appointments": [
    {
      "id": "appt-1",
      "date": "2024-12-10",
      "procedureType": "cleaning",
      "notes": "Todo en orden"
    },
    // ...
  ],
  "dentalChart": { /* odontograma */ },
  "invoices": [
    { "id": "inv-1", "amount": 1500, "status": "pending" },
    { "id": "inv-2", "amount": 3000, "status": "paid" }
  ]
}

// 3. Backend query con RLS
const history = await prisma.appointment.findMany({
  where: {
    patient_id: 'patient-789',
    tenant_id: 'tenant-123', // â­ Filtra por dentista especÃ­fico
  },
  include: {
    procedures: true,
    dentalChart: true
  },
  orderBy: {
    appointment_date: 'desc'
  }
});

// 4. View combined history (optional)
GET /api/patients/patient-789/full-history

// Response - Combina datos de TODOS los dentistas
{
  "patient": { "id": "patient-789", "name": "Luis RodrÃ­guez" },
  "timeline": [
    {
      "date": "2025-01-15",
      "dentist": "Dr. Juan PÃ©rez",
      "event": "PrÃ³xima cita - Limpieza"
    },
    {
      "date": "2024-12-10",
      "dentist": "Dr. Juan PÃ©rez",
      "event": "Limpieza"
    },
    {
      "date": "2024-06-15",
      "dentist": "Dr. Alberto GÃ³mez",
      "event": "Ãšltima cita con Dr. GÃ³mez"
    },
    // ... mÃ¡s eventos
  ]
}
```

---

## Flujo 9: AsignaciÃ³n de Consultorios

**Actor:** Super Admin
**Objetivo:** Asignar consultorio a dentista con horarios

### User Journey

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Super Admin â†’ ClÃ­nicas â†’ "ClÃ­nica ABC"                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Detalles de ClÃ­nica                                          â”‚
â”‚                                                                 â”‚
â”‚    ğŸ¥ ClÃ­nica ABC                                               â”‚
â”‚    ğŸ“ Av. Reforma 123, CDMX                                     â”‚
â”‚                                                                 â”‚
â”‚    ** Consultorios **                                           â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚    â”‚ Consultorio 1                     â”‚                       â”‚
â”‚    â”‚ â€¢ Dr. Juan PÃ©rez (Lun-Vie 9-17)  â”‚                       â”‚
â”‚    â”‚ â€¢ Dr. Carlos LÃ³pez (Vie 17-21)    â”‚                       â”‚
â”‚    â”‚ [Editar]                          â”‚                       â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                       â”‚
â”‚    â”‚ Consultorio 2                     â”‚                       â”‚
â”‚    â”‚ â€¢ Dra. MarÃ­a GarcÃ­a (Lun-Mie)     â”‚                       â”‚
â”‚    â”‚ [Editar]                          â”‚                       â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                                                 â”‚
â”‚    [Nuevo Consultorio]                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Click "Editar" en Consultorio 1                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Asignaciones de Consultorio 1                                â”‚
â”‚                                                                 â”‚
â”‚    ** Dentistas Asignados **                                    â”‚
â”‚                                                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚    â”‚ ğŸ‘¨â€âš•ï¸ Dr. Juan PÃ©rez                              â”‚         â”‚
â”‚    â”‚                                                 â”‚         â”‚
â”‚    â”‚ Horario:                                        â”‚         â”‚
â”‚    â”‚ Lunes:    09:00 - 17:00 âœ“                       â”‚         â”‚
â”‚    â”‚ Martes:   09:00 - 17:00 âœ“                       â”‚         â”‚
â”‚    â”‚ MiÃ©rcoles: 09:00 - 17:00 âœ“                       â”‚         â”‚
â”‚    â”‚ Jueves:   09:00 - 17:00 âœ“                       â”‚         â”‚
â”‚    â”‚ Viernes:  09:00 - 17:00 âœ“                       â”‚         â”‚
â”‚    â”‚ SÃ¡bado:   - No trabaja -                        â”‚         â”‚
â”‚    â”‚ Domingo:  - No trabaja -                        â”‚         â”‚
â”‚    â”‚                                                 â”‚         â”‚
â”‚    â”‚ Estado: Activo                                  â”‚         â”‚
â”‚    â”‚ [Remover]                                       â”‚         â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚    â”‚ ğŸ‘¨â€âš•ï¸ Dr. Carlos LÃ³pez                            â”‚         â”‚
â”‚    â”‚                                                 â”‚         â”‚
â”‚    â”‚ Horario:                                        â”‚         â”‚
â”‚    â”‚ Lunes-Jueves: - No trabaja -                    â”‚         â”‚
â”‚    â”‚ Viernes:  17:00 - 21:00 âœ“                       â”‚         â”‚
â”‚    â”‚ SÃ¡bado:   - No trabaja -                        â”‚         â”‚
â”‚    â”‚ Domingo:  - No trabaja -                        â”‚         â”‚
â”‚    â”‚                                                 â”‚         â”‚
â”‚    â”‚ Estado: Activo                                  â”‚         â”‚
â”‚    â”‚ [Remover]                                       â”‚         â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                 â”‚
â”‚    [+ Asignar Nuevo Dentista]                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Click "+ Asignar Nuevo Dentista"                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Modal: Nueva AsignaciÃ³n                                      â”‚
â”‚                                                                 â”‚
â”‚    Seleccionar Dentista:                                        â”‚
â”‚    [Dra. Ana MartÃ­nez â–¼]                                        â”‚
â”‚                                                                 â”‚
â”‚    Configurar Horarios:                                         â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚    â”‚ Lunes    â˜‘ 14:00 - 18:00            â”‚                     â”‚
â”‚    â”‚ Martes   â˜‘ 14:00 - 18:00            â”‚                     â”‚
â”‚    â”‚ MiÃ©rcoles â˜                          â”‚                     â”‚
â”‚    â”‚ Jueves   â˜                          â”‚                     â”‚
â”‚    â”‚ Viernes  â˜                          â”‚                     â”‚
â”‚    â”‚ SÃ¡bado   â˜                          â”‚                     â”‚
â”‚    â”‚ Domingo  â˜                          â”‚                     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                 â”‚
â”‚    Fecha de inicio: [1 Feb 2025 ğŸ“…]                             â”‚
â”‚    Fecha de fin: [Indefinido â–¼]                                 â”‚
â”‚                                                                 â”‚
â”‚    [Guardar]  [Cancelar]                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. ValidaciÃ³n de Conflictos                                     â”‚
â”‚                                                                 â”‚
â”‚    Backend valida:                                              â”‚
â”‚    âœ“ No hay overlap con otros dentistas                         â”‚
â”‚    âœ“ Horarios vÃ¡lidos (start < end)                             â”‚
â”‚    âœ“ Dentista tiene suscripciÃ³n activa                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. AsignaciÃ³n Creada                                            â”‚
â”‚                                                                 â”‚
â”‚    âœ… Consultorio asignado a Dra. Ana MartÃ­nez                  â”‚
â”‚                                                                 â”‚
â”‚    ğŸ“§ Email enviado a la doctora:                               â”‚
â”‚    "Se te ha asignado el Consultorio 1 en ClÃ­nica ABC"         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### API Calls

```typescript
// 1. Get clinic operatories with assignments
GET /api/clinics/clinic-123/operatories

// Response
{
  "clinic": { "id": "clinic-123", "name": "ClÃ­nica ABC" },
  "operatories": [
    {
      "id": "operatory-1",
      "name": "Consultorio 1",
      "assignments": [
        {
          "dentistId": "tenant-123",
          "dentistName": "Dr. Juan PÃ©rez",
          "schedule": {
            "monday": { "start": "09:00", "end": "17:00" },
            "tuesday": { "start": "09:00", "end": "17:00" },
            // ...
          }
        },
        {
          "dentistId": "tenant-456",
          "dentistName": "Dr. Carlos LÃ³pez",
          "schedule": {
            "friday": { "start": "17:00", "end": "21:00" }
          }
        }
      ]
    }
  ]
}

// 2. Create new assignment
POST /api/operatory-assignments
{
  "operatoryId": "operatory-1",
  "dentistId": "tenant-789", // Dra. Ana MartÃ­nez
  "schedule": {
    "monday": { "start": "14:00", "end": "18:00" },
    "tuesday": { "start": "14:00", "end": "18:00" }
  },
  "startDate": "2025-02-01",
  "endDate": null,
  "isActive": true
}

// Backend validation
async validateAssignment(data) {
  // 1. Check for time conflicts
  const conflicts = await prisma.operatoryAssignment.findMany({
    where: {
      operatory_id: data.operatoryId,
      is_active: true,
      // Check if schedules overlap
    }
  });

  for (const conflict of conflicts) {
    for (const day in data.schedule) {
      const existing = conflict.schedule[day];
      const newSlot = data.schedule[day];

      if (existing && this.hasTimeOverlap(existing, newSlot)) {
        throw new ConflictException(`Conflict on ${day} with ${conflict.dentist.name}`);
      }
    }
  }

  // 2. Verify dentist has active subscription
  const subscription = await prisma.subscription.findFirst({
    where: {
      tenant_id: data.dentistId,
      status: 'active'
    }
  });

  if (!subscription) {
    throw new BadRequestException('Dentist must have active subscription');
  }

  return true;
}
```

---

## Flujo 10: Cambio de Dentista

**Actor:** Paciente
**Objetivo:** Cambiar de un dentista a otro, manteniendo historial

### User Journey

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Contexto: Luis quiere dejar de ver al Dr. PÃ©rez y ver a        â”‚
â”‚           Dra. GarcÃ­a en su lugar                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Dra. GarcÃ­a â†’ Pacientes â†’ "Nuevo Paciente"                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. BÃºsqueda de Paciente                                         â”‚
â”‚    Email: luis@example.com                                      â”‚
â”‚    [Buscar]                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Paciente Encontrado                                          â”‚
â”‚                                                                 â”‚
â”‚    âœ“ Luis RodrÃ­guez GarcÃ­a                                      â”‚
â”‚    Email: luis@example.com                                      â”‚
â”‚                                                                 â”‚
â”‚    Historial previo:                                            â”‚
â”‚    â€¢ Dr. Juan PÃ©rez (Activo desde Ago 2024)                    â”‚
â”‚    â€¢ Dr. Alberto GÃ³mez (Inactivo desde Jul 2024)               â”‚
â”‚                                                                 â”‚
â”‚    â„¹ï¸ Este paciente ya estÃ¡ siendo atendido por el Dr. PÃ©rez.  â”‚
â”‚       Â¿Deseas agregarlo tambiÃ©n a tu lista?                     â”‚
â”‚                                                                 â”‚
â”‚    [SÃ­, agregar a mi lista]  [No]                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ConfirmaciÃ³n                                                 â”‚
â”‚                                                                 â”‚
â”‚    Â¿CÃ³mo proceder con la relaciÃ³n actual?                       â”‚
â”‚                                                                 â”‚
â”‚    â—‹ Mantener ambas relaciones activas                          â”‚
â”‚      (Paciente verÃ¡ a ambos doctores)                           â”‚
â”‚                                                                 â”‚
â”‚    â— Marcar relaciÃ³n con Dr. PÃ©rez como inactiva               â”‚
â”‚      (Solo te verÃ¡ a ti)                                        â”‚
â”‚                                                                 â”‚
â”‚    â—‹ Solo agregar, dejar que el paciente decida                â”‚
â”‚                                                                 â”‚
â”‚    Nota de transferencia:                                       â”‚
â”‚    [Paciente desea cambiar de dentista___]                      â”‚
â”‚                                                                 â”‚
â”‚    [Continuar]                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Backend Process                                              â”‚
â”‚                                                                 â”‚
â”‚    // Si "Marcar como inactiva" fue seleccionado:              â”‚
â”‚                                                                 â”‚
â”‚    1. Update relaciÃ³n con Dr. PÃ©rez:                            â”‚
â”‚       is_active = false                                         â”‚
â”‚       ended_at = NOW()                                          â”‚
â”‚                                                                 â”‚
â”‚    2. Create nueva relaciÃ³n con Dra. GarcÃ­a:                    â”‚
â”‚       is_active = true                                          â”‚
â”‚       started_at = NOW()                                        â”‚
â”‚                                                                 â”‚
â”‚    3. Enviar notificaciÃ³n al Dr. PÃ©rez (opcional):             â”‚
â”‚       "Paciente Luis RodrÃ­guez fue transferido"                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Paciente Agregado                                            â”‚
â”‚                                                                 â”‚
â”‚    âœ… Luis RodrÃ­guez agregado a tu lista de pacientes           â”‚
â”‚                                                                 â”‚
â”‚    Puedes ver:                                                  â”‚
â”‚    â€¢ InformaciÃ³n bÃ¡sica (nombre, contacto, alergias)            â”‚
â”‚    â€¢ Historial mÃ©dico general                                   â”‚
â”‚                                                                 â”‚
â”‚    NO puedes ver:                                               â”‚
â”‚    â€¢ Notas clÃ­nicas de Dr. PÃ©rez                                â”‚
â”‚    â€¢ Odontograma de Dr. PÃ©rez                                   â”‚
â”‚    â€¢ Treatment plans de Dr. PÃ©rez                               â”‚
â”‚                                                                 â”‚
â”‚    (Privacidad: cada dentista solo ve SUS propias notas)        â”‚
â”‚                                                                 â”‚
â”‚    [Agendar Primera Cita]  [Ver Perfil]                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Portal del Paciente - Vista de Luis                          â”‚
â”‚                                                                 â”‚
â”‚    "Mis Dentistas"                                              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚    â”‚ ğŸ¦· Dra. MarÃ­a GarcÃ­a        [NUEVO]   â”‚                   â”‚
â”‚    â”‚    Estado: Activo                     â”‚                   â”‚
â”‚    â”‚    Primera cita: Pendiente            â”‚                   â”‚
â”‚    â”‚    [Agendar]                          â”‚                   â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚    â”‚ ğŸ¦· Dr. Juan PÃ©rez                     â”‚                   â”‚
â”‚    â”‚    Estado: Inactivo (desde 15 Ene)    â”‚                   â”‚
â”‚    â”‚    Ãšltima cita: 10 Dic 2024          â”‚                   â”‚
â”‚    â”‚    [Ver Historial]                    â”‚                   â”‚
â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
â”‚    â”‚ ğŸ¦· Dr. Alberto GÃ³mez                  â”‚                   â”‚
â”‚    â”‚    Estado: Inactivo (desde Jul 2024)  â”‚                   â”‚
â”‚    â”‚    [Ver Historial]                    â”‚                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### API Calls & Database Updates

```typescript
// 1. Check if patient exists and has active relationships
GET /api/patients/search?email=luis@example.com

// Response
{
  "patient": {
    "id": "patient-789",
    "name": "Luis RodrÃ­guez GarcÃ­a",
    "activeRelations": [
      {
        "dentistId": "tenant-123",
        "dentistName": "Dr. Juan PÃ©rez",
        "since": "2024-08-01",
        "isActive": true
      }
    ]
  }
}

// 2. Create new relation with option to deactivate previous
POST /api/patient-dentist-relations
{
  "patientId": "patient-789",
  "newDentistId": "tenant-456", // Dra. GarcÃ­a
  "deactivatePrevious": true, // Si el usuario eligiÃ³ esta opciÃ³n
  "previousDentistId": "tenant-123", // Dr. PÃ©rez
  "transferNote": "Paciente desea cambiar de dentista"
}

// Backend implementation
async transferPatient(data) {
  return await prisma.$transaction(async (tx) => {
    // 1. Deactivate previous relation if requested
    if (data.deactivatePrevious) {
      await tx.patientDentistRelation.updateMany({
        where: {
          patient_id: data.patientId,
          dentist_id: data.previousDentistId,
          is_active: true
        },
        data: {
          is_active: false,
          ended_at: new Date(),
          end_reason: 'transferred',
          transfer_note: data.transferNote
        }
      });
    }

    // 2. Create new relation
    const newRelation = await tx.patientDentistRelation.create({
      data: {
        patient_id: data.patientId,
        dentist_id: data.newDentistId,
        tenant_id: data.newDentistId,
        is_active: true,
        started_at: new Date(),
        notes: `Transferred from ${data.previousDentistId}`
      }
    });

    // 3. Send notification to previous dentist (optional)
    if (data.deactivatePrevious) {
      await this.notificationService.send({
        to: data.previousDentistId,
        type: 'patient_transferred',
        data: {
          patientName: patient.name,
          newDentist: data.newDentistId
        }
      });
    }

    return newRelation;
  });
}

// 3. Query patient data with RLS
// Dra. GarcÃ­a puede ver:
const patientBasicInfo = await prisma.patient.findUnique({
  where: { id: 'patient-789' },
  select: {
    id: true,
    firstName: true,
    lastName: true,
    email: true,
    phone: true,
    dateOfBirth: true,
    // Info mÃ©dica bÃ¡sica
    medicalHistory: {
      select: {
        allergies: true,
        conditions: true,
        medications: true
      }
    }
  }
});

// Dra. GarcÃ­a NO puede ver (tenant_id filtering):
const drPerezNotes = await prisma.clinicalNote.findMany({
  where: {
    patient_id: 'patient-789',
    tenant_id: 'tenant-123' // Dr. PÃ©rez
    // â›” Dra. GarcÃ­a tiene tenant_id = 'tenant-456'
    // â›” Esta query no retornarÃ¡ nada para ella
  }
});

// Solo puede ver SUS propias notas:
const drGarciaNotes = await prisma.clinicalNote.findMany({
  where: {
    patient_id: 'patient-789',
    tenant_id: 'tenant-456' // âœ“ Dra. GarcÃ­a
  }
});
```

---

## Resumen de Flujos CrÃ­ticos

### Prioridad Alta (MVP)

1. âœ… **Registro de Dentista** - Onboarding inicial
2. âœ… **ConfiguraciÃ³n WhatsApp** - Feature diferenciador
3. âœ… **Agendar Cita (Dashboard)** - Core functionality
4. âœ… **Agendar Cita (WhatsApp)** - Automated scheduling
5. âœ… **Registro de Paciente** - Patient management

### Prioridad Media (Fase 2)

6. âœ… **InvitaciÃ³n de Staff** - Team collaboration
7. âœ… **Staff Multi-Dentista** - Staff flexibility
8. âœ… **AsignaciÃ³n de Consultorios** - Operatory management

### Prioridad Baja (Fase 3)

9. âœ… **Paciente Multi-Dentista** - Advanced patient features
10. âœ… **Cambio de Dentista** - Patient transfer

---

**VersiÃ³n:** 1.0
**Ãšltima actualizaciÃ³n:** 30 de Diciembre, 2025
